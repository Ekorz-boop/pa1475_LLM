{% extends "admin/base.html" %}

{% block title %}Edit User{% endblock %}

{% block header %}Edit User{% endblock %}

{% block content %}
<div class="edit-user-container">
    <form method="POST" class="edit-user-form">
        {{ form.hidden_tag() }}
        
        <div class="form-group">
            {{ form.username.label }}
            {{ form.username(class="form-control") }}
            {% if form.username.errors %}
                <div class="error-message">
                    {% for error in form.username.errors %}
                        <span>{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.email.label }}
            {{ form.email(class="form-control") }}
            {% if form.email.errors %}
                <div class="error-message">
                    {% for error in form.email.errors %}
                        <span>{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.password.label }}
            {{ form.password(class="form-control") }}
            {% if form.password.errors %}
                <div class="error-message">
                    {% for error in form.password.errors %}
                        <span>{{ error }}</span>
                    {% endfor %}
                </div>
            {% endif %}
            <small class="form-text">Leave blank to keep current password</small>
        </div>

        <div class="form-group checkbox-group">
            {{ form.is_active(class="form-checkbox") }}
            {{ form.is_active.label }}
        </div>

        <div class="form-group checkbox-group">
            {{ form.is_admin(class="form-checkbox") }}
            {{ form.is_admin.label }}
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="{{ url_for('admin.manage_users') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>

    <div class="user-info-card">
        <h3>User Information</h3>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Created</span>
                <span class="info-value">{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Last Login</span>
                <span class="info-value">{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Login Count</span>
                <span class="info-value">{{ user.login_count }}</span>
            </div>
        </div>

        <div class="action-buttons">
            <button onclick="resetPassword({{ user.id }})" class="btn btn-warning" title="Reset Password">
                <img src="/static/images/icons/reset.svg" alt="Reset">
            </button>
            <button onclick="deleteUser({{ user.id }})" class="btn btn-danger" title="Delete User">
                <img src="/static/images/icons/delete.svg" alt="Delete">
            </button>
        </div>
    </div>
</div>

<script>
function resetPassword(userId) {
    if (confirm('Are you sure you want to reset this user\'s password?')) {
        fetch(`/admin/user/${userId}/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Password reset email has been sent to the user.');
            } else {
                alert('Error: ' + data.message);
            }
        });
    }
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        fetch(`/admin/user/${userId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = "{{ url_for('admin.manage_users') }}";
            } else {
                alert('Error: ' + data.message);
            }
        });
    }
}
</script>
{% endblock %} 