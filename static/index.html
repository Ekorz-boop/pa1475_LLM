<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM RAG Pipeline Builder</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/blocks.css">
    <link rel="stylesheet" href="/static/css/block_content.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link rel="stylesheet" href="/static/css/topbar.css">
    <link rel="stylesheet" href="/static/css/canvas.css">
    <link rel="stylesheet" href="/static/css/management_window.css">
</head>
<body>
    <div id="app">
        <div id="notification-banner" class="notification-hidden">
            <span>⚠️ Ollama is not running. Some features will be unavailable.</span>
            <button id="open-management">Open System Management</button>
            <button class="close-notification">×</button>
        </div>
        <div id="top-bar">
            <button id="run-all" class="run-button">Run Pipeline</button>
            <button id="export-pipeline" class="export-button">Export Pipeline</button>
            <button id="management-button" class="management-button">System Management</button>
        </div>
        <div class="main-content">
            <div id="sidebar">
                <h3>Blocks</h3>
                <div class="search-container">
                    <input type="text" id="block-search" placeholder="Search blocks...">
                </div>
                
                <!-- PDF Loader Block Template -->
                <div class="block-template" draggable="true" data-block-type="pdf_loader">
                    <div class="node-container">
                        <div class="output-node" data-output="Documents"></div>
                    </div>
                    <div class="block-content-wrapper">
                        <div class="block-drag-handle">PDF Loader</div>
                        <div class="block-content">
                            <div class="input-group">
                                <input type="file" class="file-input" accept=".pdf" multiple>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Text Splitter Block Template -->
                <div class="block-template" draggable="true" data-block-type="text_splitter">
                    <div class="node-container">
                        <div class="input-node" data-input="Documents"></div>
                        <div class="output-node" data-output="Chunks"></div>
                    </div>
                    <div class="block-content-wrapper">
                        <div class="block-drag-handle">Text Splitter</div>
                        <div class="block-content">
                            <div class="input-group">
                                <label>Chunk Size:</label>
                                <input type="number" class="chunk-size" value="1000" min="100" step="100">
                            </div>
                            <div class="input-group">
                                <label>Overlap:</label>
                                <input type="number" class="chunk-overlap" value="200" min="0" step="50">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Embeddings Block Template -->
                <div class="block-template" draggable="true" data-block-type="embedding">
                    <div class="node-container">
                        <div class="input-node" data-input="Text"></div>
                        <div class="output-node" data-output="Embeddings"></div>
                    </div>
                    <div class="block-content-wrapper">
                        <div class="block-drag-handle">Embeddings</div>
                        <div class="block-content">
                            <select class="model-selector">
                                <option value="nomic-embed-text">Nomic Embed</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Vector Store Block Template -->
                <div class="block-template" draggable="true" data-block-type="vector_store">
                    <div class="node-container">
                        <!-- Document Storage Path -->
                        <div class="input-node-group storage-inputs">
                            <div class="input-node" data-input="StorageChunks" data-label="Storage Chunks"></div>
                            <div class="input-node" data-input="StorageEmbeddings" data-label="Storage Embeddings"></div>
                        </div>
                        <!-- Query Path -->
                        <div class="input-node-group query-inputs">
                            <div class="input-node" data-input="Query" data-label="Query"></div>
                            <div class="input-node" data-input="QueryEmbeddings" data-label="Query Embeddings"></div>
                        </div>
                        <div class="output-node" data-output="RetrievedDocs"></div>
                    </div>
                    <div class="block-content-wrapper">
                        <div class="block-drag-handle">Vector Store</div>
                        <div class="block-content">
                            <div class="vector-store-status">
                                <div class="status-indicator"></div>
                                <span class="status">Not initialized</span>
                            </div>
                            <div class="input-group">
                                <label>Top K:</label>
                                <input type="number" class="top-k" value="3" min="1" step="1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Query Input Block Template -->
                <div class="block-template" draggable="true" data-block-type="query_input">
                    <div class="node-container">
                        <div class="output-node" data-output="Query"></div>
                    </div>
                    <div class="block-content-wrapper">
                        <div class="block-drag-handle">Query Input</div>
                        <div class="block-content">
                            <div class="chat-interface">
                                <div class="chat-messages"></div>
                                <div class="chat-input">
                                    <input type="text" placeholder="Ask a question...">
                                    <button>Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Retrieval Ranking Block Template -->
                <div class="block-template" draggable="true" data-block-type="retrieval_ranking">
                    <div class="node-container">
                        <div class="input-node" data-input="Chunks"></div>
                        <div class="output-node" data-output="RankedContext"></div>
                    </div>
                    <div class="block-content-wrapper">
                        <div class="block-drag-handle">Retrieval Ranking</div>
                        <div class="block-content">
                            <div class="input-group">
                                <label>Ranking Method:</label>
                                <select class="ranking-method">
                                    <option value="similarity">Similarity Score</option>
                                    <option value="mmr">MMR (Diversity)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Diversity Weight (MMR):</label>
                                <input type="number" class="diversity-weight" value="0.3" min="0" max="1" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Model Block Template -->
                <div class="block-template" draggable="true" data-block-type="ai_model">
                    <div class="node-container">
                        <!-- Model Inputs -->
                        <div class="input-node-group model-inputs">
                            <div class="input-node" data-input="Query" data-label="Query"></div>
                            <div class="input-node" data-input="Context" data-label="Vector Store"></div>
                        </div>
                        <div class="output-node" data-output="Response"></div>
                    </div>
                    <div class="block-content-wrapper">
                        <div class="block-drag-handle">AI Model</div>
                        <div class="block-content">
                            <select class="model-selector">
                                <option value="tinyllama">TinyLlama</option>
                            </select>
                            <div class="input-group">
                                <label>Temperature:</label>
                                <input type="number" class="temperature" value="0.75" min="0" max="1" step="0.1">
                            </div>
                            <textarea class="prompt-template" rows="4" placeholder="Enter your prompt template...">Answer the following question using the provided context. If the context doesn't contain enough information, say so.

Context: {context}

Question: {query}

Answer:</textarea>
                        </div>
                    </div>
                </div>

                <!-- Answer Display Block Template -->
                <div class="block-template" draggable="true" data-block-type="answer_display">
                    <div class="node-container">
                        <div class="input-node" data-input="Answer"></div>
                    </div>
                    <div class="block-content-wrapper">
                        <div class="block-drag-handle">Answer Display</div>
                        <div class="block-content">
                            <div class="answer-display">No answer yet</div>
                            <div class="context-display">
                                <h4>Used Context:</h4>
                                <div class="context-chunks"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div id="canvas">
                <div class="canvas-container">
                    <div class="canvas-grid"></div>
                    <svg id="connections"></svg>
                </div>
                <div class="zoom-controls">
                    <button class="zoom-button" id="zoom-in">+</button>
                    <div class="zoom-level">100%</div>
                    <button class="zoom-button" id="zoom-out">−</button>
                    <button class="zoom-button" id="zoom-fit">⟲</button>
                </div>
            </div>
        </div>

        <!-- Add the management panel HTML directly -->
        <div id="system-management" class="management-panel">
            <div class="management-header">
                <h2>System Status</h2>
                <button class="close-button">×</button>
            </div>
            
            <div class="management-content">
                <div class="status-items">
                    <div class="status-item">
                        <span class="status-label">Status:</span>
                        <span class="status-value" id="ollama-status">Checking...</span>
                    </div>
                </div>

                <div class="models-list">
                    <h3>Available Models</h3>
                    <div id="ollama-models">Loading models...</div>
                </div>
            </div>
        </div>
    </div>
    <script src="/static/app.js"></script>

    <!-- Add this right after the body opening tag -->
    <div id="notification-system">
        <div id="toast-container"></div>
        <div id="modal-container"></div>
    </div>

    <!-- Add this before the closing body tag -->
    <div id="progress-modal" class="modal">
        <div class="modal-content">
            <h3 id="progress-title">Processing...</h3>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <div id="progress-status">Initializing...</div>
        </div>
    </div>

    <style>
    /* Toast Notifications */
    #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    .toast {
        background: white;
        border-radius: 4px;
        padding: 16px;
        margin-bottom: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 300px;
        max-width: 400px;
        animation: slideIn 0.3s ease;
    }

    .toast.success {
        border-left: 4px solid #4caf50;
    }

    .toast.error {
        border-left: 4px solid #f44336;
    }

    .toast.info {
        border-left: 4px solid #2196f3;
    }

    .toast.warning {
        border-left: 4px solid #ff9800;
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* Progress Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        padding: 24px;
        border-radius: 8px;
        min-width: 400px;
        text-align: center;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #eee;
        border-radius: 4px;
        margin: 16px 0;
        overflow: hidden;
    }

    .progress-fill {
        width: 0%;
        height: 100%;
        background: #4caf50;
        transition: width 0.3s ease;
    }

    #progress-status {
        color: #666;
        margin-top: 12px;
        font-size: 14px;
    }
    </style>
</body>
</html>
